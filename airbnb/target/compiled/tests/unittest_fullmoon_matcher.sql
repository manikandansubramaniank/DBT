WITH
              	"AIRBNB_DEV_fct_reviews" as (SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-13' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT
UNION ALL
SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-14' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT
UNION ALL
SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-15' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT),
  	"AIRBNB_DEV_seed_full_moon_dates" as (SELECT CAST('2025-01-14' AS DATE) AS FULL_MOON_DATE),
  	"AIRBNB_DEV_mart_fullmoon_reviews_expect" as (SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-13' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT, CAST('not full moon' AS VARCHAR) AS IS_FULL_MOON
UNION ALL
SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-14' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT, CAST('not full moon' AS VARCHAR) AS IS_FULL_MOON
UNION ALL
SELECT CAST(NULL AS VARCHAR) AS REVIEW_ID, CAST(NULL AS NUMBER) AS LISTING_ID, CAST('2025-01-15' AS TIMESTAMP_NTZ(9)) AS REVIEW_DATE, CAST(NULL AS VARCHAR) AS REVIEWER_NAME, CAST(NULL AS VARCHAR) AS REVIEW_TEXT, CAST(NULL AS VARCHAR) AS REVIEW_SENTIMENT, CAST('full moon' AS VARCHAR) AS IS_FULL_MOON),
  	"AIRBNB_DEV_mart_fullmoon_reviews_actual" as (

WITH fct_reviews AS (
    SELECT * FROM "AIRBNB_DEV_fct_reviews"
),
full_moon_dates AS (
    SELECT * FROM "AIRBNB_DEV_seed_full_moon_dates"
)

SELECT
  r.*,
  CASE
    WHEN fm.full_moon_date IS NULL THEN 'not full moon'
    ELSE 'full moon'
  END AS is_full_moon
FROM
  fct_reviews
  r
  LEFT JOIN full_moon_dates
  fm
  ON (TO_DATE(r.review_date) = DATEADD(DAY, 1, fm.full_moon_date))
)
            (SELECT IS_FULL_MOON, REVIEW_DATE, 'actual' AS actual_or_expected FROM "AIRBNB_DEV_mart_fullmoon_reviews_actual")
            UNION ALL
            (SELECT IS_FULL_MOON, REVIEW_DATE, 'expected' AS actual_or_expected FROM "AIRBNB_DEV_mart_fullmoon_reviews_expect")
            ORDER BY IS_FULL_MOON, REVIEW_DATE